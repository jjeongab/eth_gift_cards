<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Gift Card System</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        input {
            width: 250px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .wallet-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÅ Ethereum Gift Card System</h1>
        
        <div class="wallet-info">
            <div id="walletStatus">Not connected to wallet</div>
            <button id="connectWallet" onclick="connectWallet()">Connect MetaMask</button>
        </div>

        <div class="section">
            <h2>Buy Gift Card</h2>
            <div>
                <input type="text" id="buyCode" placeholder="Enter gift card code" />
                <input type="number" id="ethAmount" placeholder="ETH amount" step="0.001" min="0.001" />
                <button onclick="buyGiftCard()">Buy Gift Card</button>
            </div>
            <div id="buyStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Redeem Gift Card</h2>
            <div>
                <input type="text" id="redeemCode" placeholder="Enter gift card code" />
                <button onclick="redeemGiftCard()">Redeem Gift Card</button>
            </div>
            <div id="redeemStatus" class="status"></div>
        </div>
    </div>

    <script>
        // Contract ABI
        const CONTRACT_ABI = [
            "function buy(bytes32 codeHash) public payable",
            "function redeem(string memory code) public",
            "function getGiftCardValue(bytes32 codeHash) public view returns (uint256)",
            "function isRedeemed(bytes32 codeHash) public view returns (bool)",
            "event GiftCardPurchased(bytes32 indexed codeHash, uint256 value)",
            "event GiftCardRedeemed(bytes32 indexed codeHash, address redeemer, uint256 value)"
        ];

        // Replace with your deployed contract address
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // Default Hardhat address

        let provider;
        let signer;
        let contract;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    const address = await signer.getAddress();
                    document.getElementById('walletStatus').textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
                    document.getElementById('connectWallet').textContent = 'Connected';
                    document.getElementById('connectWallet').disabled = true;
                    
                    showStatus('buyStatus', 'Wallet connected successfully!', 'success');
                } catch (error) {
                    showStatus('buyStatus', 'Failed to connect wallet: ' + error.message, 'error');
                }
            } else {
                showStatus('buyStatus', 'Please install MetaMask!', 'error');
            }
        }

        async function buyGiftCard() {
            if (!contract) {
                showStatus('buyStatus', 'Please connect your wallet first!', 'error');
                return;
            }

            const code = document.getElementById('buyCode').value;
            const ethAmount = document.getElementById('ethAmount').value;

            if (!code || !ethAmount) {
                showStatus('buyStatus', 'Please enter both code and ETH amount!', 'error');
                return;
            }

            if (parseFloat(ethAmount) < 0.001) {
                showStatus('buyStatus', 'Minimum gift card value is 0.001 ETH!', 'error');
                return;
            }

            try {
                showStatus('buyStatus', 'Processing transaction...', 'info');
                
                const codeHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(code));
                const tx = await contract.buy(codeHash, {
                    value: ethers.utils.parseEther(ethAmount)
                });
                
                showStatus('buyStatus', 'Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();
                
                showStatus('buyStatus', `Gift card purchased successfully! Code: ${code}, Value: ${ethAmount} ETH`, 'success');
                document.getElementById('buyCode').value = '';
                document.getElementById('ethAmount').value = '';
            } catch (error) {
                showStatus('buyStatus', 'Error: ' + error.message, 'error');
            }
        }

        async function redeemGiftCard() {
            if (!contract) {
                showStatus('redeemStatus', 'Please connect your wallet first!', 'error');
                return;
            }

            const code = document.getElementById('redeemCode').value;

            if (!code) {
                showStatus('redeemStatus', 'Please enter the gift card code!', 'error');
                return;
            }

            try {
                showStatus('redeemStatus', 'Processing redemption...', 'info');
                
                const tx = await contract.redeem(code);
                
                showStatus('redeemStatus', 'Transaction submitted. Waiting for confirmation...', 'info');
                const receipt = await tx.wait();
                
                showStatus('redeemStatus', 'Gift card redeemed successfully! Check your wallet balance.', 'success');
                document.getElementById('redeemCode').value = '';
            } catch (error) {
                showStatus('redeemStatus', 'Error: ' + error.message, 'error');
            }
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
            statusElement.style.display = 'block';
        }

        // Auto-connect if wallet is already connected
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
    </script>
</body>
</html>